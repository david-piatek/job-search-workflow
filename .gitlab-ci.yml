# GitLab CI/CD Configuration
# GitHub → Tests, Lint, SonarQube
# GitLab → Docker Build + Deploy (ArgoCD)

stages:
  - build
  - update-manifest
  - deploy

variables:
  DOCKER_REGISTRY: registry.gitlab.com/dav.piatek/job-search-workflow
  ARGOCD_SERVER: argocd.draw-me-the-moon.fr
  ARGOCD_APP_NAME: job-search-workflow
  DOCKER_TLS_CERTDIR: "/certs"
  DOCKER_DRIVER: overlay2

# Docker build backend
docker-build-backend:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "develop"'
      changes:
        - apps/backend/**/*
        - cloud/docker/Dockerfile.backend
        - cloud/docker/docker-bake.hcl
        - cloud/helm/**/*
        - package.json
        - pnpm-lock.yaml
        - pnpm-workspace.yaml
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - echo "Building Backend Docker image..."
    - export TAG=$CI_COMMIT_SHORT_SHA
    - export COMMIT_SHA=$CI_COMMIT_SHORT_SHA
    - export BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
    - export REGISTRY=$DOCKER_REGISTRY
    - export BUILDX_BAKE_ENTITLEMENTS_FS=0
    - docker context create builder-context || true
    - docker buildx create --use --name builder builder-context || docker buildx use builder
    - docker buildx bake -f cloud/docker/docker-bake.hcl backend-prod --push

# Docker build frontend
docker-build-frontend:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "develop"'
      changes:
        - apps/frontend/**/*
        - cloud/docker/Dockerfile.frontend
        - cloud/docker/docker-bake.hcl
        - cloud/helm/**/*
        - package.json
        - pnpm-lock.yaml
        - pnpm-workspace.yaml
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - echo "Building Frontend Docker image..."
    - export TAG=$CI_COMMIT_SHORT_SHA
    - export COMMIT_SHA=$CI_COMMIT_SHORT_SHA
    - export BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
    - export REGISTRY=$DOCKER_REGISTRY
    - export BUILDX_BAKE_ENTITLEMENTS_FS=0
    - docker context create builder-context || true
    - docker buildx create --use --name builder builder-context || docker buildx use builder
    - docker buildx bake -f cloud/docker/docker-bake.hcl frontend-prod --push

sync-deploy-repo:
  stage: update-manifest
  image: alpine:latest
  only:
    - main
  needs:
    - job: docker-build-backend
      optional: true
    - job: docker-build-frontend
      optional: true
  before_script:
    - apk add --no-cache git yq
    - git config --global user.email "ci@gitlab.com"
    - git config --global user.name "GitLab CI"
  script:
    - |
      echo "Updating Helm values with tag ${CI_COMMIT_SHORT_SHA}"
      yq -i ".image.backend.tag = \"${CI_COMMIT_SHORT_SHA}\"" cloud/helm/job-search-workflow-app/values-simple.yaml
      yq -i ".image.frontend.tag = \"${CI_COMMIT_SHORT_SHA}\"" cloud/helm/job-search-workflow-app/values-simple.yaml
      echo "Syncing to deploy repo..."
      mkdir -p /tmp/deploy-repo && cd /tmp/deploy-repo
      git init
      git remote add origin https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.com/dav.piatek/job-search-workflow-deploy.git
      mkdir -p helm && cp -r ${CI_PROJECT_DIR}/cloud/helm/* helm/
      echo "# Deployment Repository - Helm Charts" > README.md
      git add .
      git commit -m "sync: ${CI_COMMIT_SHORT_SHA}"
      git push --force origin HEAD:main
